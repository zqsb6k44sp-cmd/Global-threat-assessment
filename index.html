<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Situation Monitor</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <h1 class="title">Situation Monitor</h1>
            <span class="status" id="status">Ready</span>
        </div>
        <div class="header-right">
            <button class="refresh-btn monitors-btn" onclick="openMonitorForm()">+ Monitor</button>
            <button class="settings-btn" onclick="toggleSettings()">Panels</button>
            <button class="refresh-btn" id="refreshBtn" onclick="refreshAll()">Refresh</button>
        </div>
    </header>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal" onclick="if(event.target === this) toggleSettings()">
        <div class="settings-content">
            <div class="settings-title">Panel Settings</div>
            <div class="settings-section">
                <div class="settings-section-title">Toggle Panels</div>
                <div id="panelToggles"></div>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">Layout</div>
                <div class="settings-hint" style="margin-bottom: 0.5rem;">Drag panel headers to reorder</div>
                <button class="settings-reset" onclick="resetPanelOrder()">Reset Layout</button>
            </div>
            <div class="settings-section monitors-section">
                <div class="settings-section-title">Custom Monitors</div>
                <div class="settings-hint" style="margin-bottom: 0.5rem;">Track keywords with optional map locations</div>
                <div class="monitors-list" id="monitorsList"></div>
                <button class="add-monitor-btn" onclick="openMonitorForm()">+ Add Monitor</button>
            </div>
            <button class="settings-close" onclick="toggleSettings()">Close</button>
        </div>
    </div>

    <!-- Monitor Form Modal -->
    <div class="monitor-form-overlay" id="monitorFormOverlay" onclick="if(event.target === this) closeMonitorForm()">
        <div class="monitor-form">
            <div class="monitor-form-title" id="monitorFormTitle">Add Monitor</div>
            <input type="hidden" id="monitorEditId">
            <div class="monitor-form-field">
                <label class="monitor-form-label">Name</label>
                <input type="text" class="monitor-form-input" id="monitorName" placeholder="e.g., TSMC Supply Chain">
            </div>
            <div class="monitor-form-field">
                <label class="monitor-form-label">Keywords</label>
                <input type="text" class="monitor-form-input" id="monitorKeywords" placeholder="e.g., tsmc, taiwan semiconductor, chip">
                <div class="monitor-form-hint">Comma-separated. Matches headlines containing any keyword.</div>
            </div>
            <div class="monitor-form-field">
                <label class="monitor-form-label">Color</label>
                <div class="monitor-form-colors" id="monitorColors"></div>
            </div>
            <div class="monitor-form-field">
                <label class="monitor-form-label">Map Location (Optional)</label>
                <div class="monitor-form-location">
                    <input type="text" class="monitor-form-input" id="monitorLat" placeholder="Latitude">
                    <input type="text" class="monitor-form-input" id="monitorLon" placeholder="Longitude">
                </div>
                <div class="monitor-form-hint">Leave blank for keyword-only monitoring. Add coords to show on map.</div>
            </div>
            <div class="monitor-form-actions">
                <button class="monitor-cancel-btn" onclick="closeMonitorForm()">Cancel</button>
                <button class="monitor-save-btn" onclick="saveMonitor()">Save</button>
            </div>
        </div>
    </div>

    <main class="dashboard">
        <!-- Global Intelligence Map -->
        <section class="panel" data-panel="map" style="grid-column: span 4;">
            <div class="panel-header">
                <span class="panel-title">Global Activity Monitor</span>
                <span class="panel-count" id="mapLegend">
                    <span style="color: var(--green);">‚óè Low</span>
                    <span style="color: var(--yellow); margin-left: 0.5rem;">‚óè Elevated</span>
                    <span style="color: var(--red); margin-left: 0.5rem;">‚óè High</span>
                </span>
            </div>
            <div class="panel-content" id="mapPanel" style="max-height: none; height: 550px; overflow: hidden; background: #0a1a14; position: relative;">
                <svg id="mapSvg" style="width:100%;height:100%;"></svg>
                <div id="mapTooltip" style="position:absolute;display:none;background:rgba(0,20,15,0.95);border:1px solid #00ff88;padding:8px 12px;border-radius:4px;font-size:11px;color:#00ff88;pointer-events:none;z-index:1000;max-width:200px;font-family:monospace;"></div>
            </div>
            <script>
                // Inline map render with hotspots
                (async function() {
                    const svg = d3.select('#mapSvg');
                    const tooltip = document.getElementById('mapTooltip');
                    const mapPanel = document.getElementById('mapPanel');
                    const width = 800, height = 500;
                    svg.attr('viewBox', `0 0 ${width} ${height}`);

                    const projection = d3.geoEquirectangular()
                        .scale(130)
                        .center([0, 20])
                        .translate([width/2, height/2]);

                    const path = d3.geoPath().projection(projection);

                    // Threat level colors
                    const threatColors = {
                        high: '#ff4444',
                        elevated: '#ffcc00',
                        low: '#00ff88'
                    };

                    // Hotspots data with descriptions and threat levels
                    const hotspots = [
                        { name: 'DC', lat: 38.9, lon: -77.0, level: 'low', desc: 'Washington DC ‚Äî US political center, White House, Pentagon, Capitol' },
                        { name: 'Moscow', lat: 55.75, lon: 37.6, level: 'elevated', desc: 'Moscow ‚Äî Kremlin, Russian military command, sanctions hub' },
                        { name: 'Beijing', lat: 39.9, lon: 116.4, level: 'elevated', desc: 'Beijing ‚Äî CCP headquarters, US-China tensions, tech rivalry' },
                        { name: 'Kyiv', lat: 50.45, lon: 30.5, level: 'high', desc: 'Kyiv ‚Äî Active conflict zone, Russian invasion ongoing' },
                        { name: 'Taipei', lat: 25.03, lon: 121.5, level: 'elevated', desc: 'Taipei ‚Äî Taiwan Strait tensions, TSMC, China threat' },
                        { name: 'Tehran', lat: 35.7, lon: 51.4, level: 'high', desc: 'Tehran ‚Äî Iran nuclear program, proxy conflicts, regional escalation' },
                        { name: 'Tel Aviv', lat: 32.07, lon: 34.78, level: 'high', desc: 'Tel Aviv ‚Äî Israel-Gaza conflict, active military operations' },
                        { name: 'London', lat: 51.5, lon: -0.12, level: 'low', desc: 'London ‚Äî Financial center, Five Eyes, NATO ally' },
                        { name: 'Brussels', lat: 50.85, lon: 4.35, level: 'low', desc: 'Brussels ‚Äî EU/NATO headquarters, European policy' },
                        { name: 'Pyongyang', lat: 39.03, lon: 125.75, level: 'elevated', desc: 'Pyongyang ‚Äî North Korea nuclear threat, missile tests' },
                        { name: 'Riyadh', lat: 24.7, lon: 46.7, level: 'elevated', desc: 'Riyadh ‚Äî Saudi oil, OPEC+, Yemen conflict, regional power' },
                        { name: 'Delhi', lat: 28.6, lon: 77.2, level: 'low', desc: 'Delhi ‚Äî India rising power, China border tensions' },
                        { name: 'Singapore', lat: 1.35, lon: 103.82, level: 'low', desc: 'Singapore ‚Äî Shipping chokepoint, Asian finance hub' },
                        { name: 'Tokyo', lat: 35.68, lon: 139.76, level: 'low', desc: 'Tokyo ‚Äî US ally, regional security, economic power' }
                    ];

                    try {
                        const response = await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json');
                        const world = await response.json();
                        const countries = topojson.feature(world, world.objects.countries);

                        // Draw countries
                        svg.selectAll('path')
                            .data(countries.features)
                            .enter()
                            .append('path')
                            .attr('d', path)
                            .attr('fill', '#0f3028')
                            .attr('stroke', '#1a5040')
                            .attr('stroke-width', 0.5);

                        // Add pulse animation style
                        const style = document.createElement('style');
                        style.textContent = `
                            @keyframes pulse {
                                0% { r: 3; opacity: 0.9; }
                                50% { r: 6; opacity: 0.4; }
                                100% { r: 3; opacity: 0.9; }
                            }
                            .hotspot-pulse { animation: pulse 2s ease-in-out infinite; }
                            .hotspot-hit { cursor: pointer; }
                        `;
                        document.head.appendChild(style);

                        // Draw hotspots
                        hotspots.forEach(h => {
                            const [x, y] = projection([h.lon, h.lat]);
                            const color = threatColors[h.level] || threatColors.low;
                            if (x && y) {
                                // Outer pulsing ring
                                svg.append('circle')
                                    .attr('cx', x).attr('cy', y).attr('r', 6)
                                    .attr('fill', 'none').attr('stroke', color)
                                    .attr('stroke-width', 1.5).attr('opacity', 0.6)
                                    .attr('class', 'hotspot-pulse');
                                // Inner solid circle
                                svg.append('circle')
                                    .attr('cx', x).attr('cy', y).attr('r', 3)
                                    .attr('fill', color).attr('opacity', 0.9);
                                // Label
                                svg.append('text')
                                    .attr('x', x + 8).attr('y', y + 3)
                                    .attr('fill', color).attr('font-size', '8px')
                                    .attr('font-family', 'monospace')
                                    .text(h.name);
                                // Invisible hit area for tooltip
                                svg.append('circle')
                                    .attr('cx', x).attr('cy', y).attr('r', 12)
                                    .attr('fill', 'transparent')
                                    .attr('class', 'hotspot-hit')
                                    .on('mouseenter', function(event) {
                                        const rect = mapPanel.getBoundingClientRect();
                                        const levelLabel = h.level.charAt(0).toUpperCase() + h.level.slice(1);
                                        tooltip.innerHTML = `<strong style="color:${color}">[${levelLabel}]</strong> ${h.desc}`;
                                        tooltip.style.display = 'block';
                                        tooltip.style.left = (event.clientX - rect.left + 15) + 'px';
                                        tooltip.style.top = (event.clientY - rect.top - 10) + 'px';
                                    })
                                    .on('mousemove', function(event) {
                                        const rect = mapPanel.getBoundingClientRect();
                                        tooltip.style.left = (event.clientX - rect.left + 15) + 'px';
                                        tooltip.style.top = (event.clientY - rect.top - 10) + 'px';
                                    })
                                    .on('mouseleave', function() {
                                        tooltip.style.display = 'none';
                                    });
                            }
                        });
                    } catch(e) {
                        console.error('Map error:', e);
                    }
                })();
            </script>
        </section>

        <!-- Political / World News -->
        <section class="panel" data-panel="politics">
            <div class="panel-header">
                <span class="panel-title">World / Geopolitical</span>
                <span class="panel-count" id="politicsCount">-</span>
            </div>
            <div class="panel-content" id="politicsPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Technology News -->
        <section class="panel" data-panel="tech">
            <div class="panel-header">
                <span class="panel-title">Technology / AI</span>
                <span class="panel-count" id="techCount">-</span>
            </div>
            <div class="panel-content" id="techPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Financial News -->
        <section class="panel" data-panel="finance">
            <div class="panel-header">
                <span class="panel-title">Financial</span>
                <span class="panel-count" id="financeCount">-</span>
            </div>
            <div class="panel-content" id="financePanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Government / Policy -->
        <section class="panel" data-panel="gov">
            <div class="panel-header">
                <span class="panel-title">Government / Policy</span>
                <span class="panel-count" id="govCount">-</span>
            </div>
            <div class="panel-content" id="govPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Sector Heatmap -->
        <section class="panel" data-panel="heatmap">
            <div class="panel-header">
                <span class="panel-title">Sector Heatmap</span>
            </div>
            <div class="panel-content" id="heatmapPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Markets -->
        <section class="panel wide" data-panel="markets">
            <div class="panel-header">
                <span class="panel-title">Markets</span>
                <span class="panel-count" id="marketsCount">-</span>
            </div>
            <div class="panel-content" id="marketsPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Commodities -->
        <section class="panel" data-panel="commodities">
            <div class="panel-header">
                <span class="panel-title">Commodities / VIX</span>
            </div>
            <div class="panel-content" id="commoditiesPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Polymarket -->
        <section class="panel wide" data-panel="polymarket">
            <div class="panel-header">
                <span class="panel-title">Polymarket Predictions</span>
                <span class="panel-count" id="polymarketCount">-</span>
            </div>
            <div class="panel-content" id="polymarketPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Whale Wallet Watch -->
        <section class="panel" data-panel="whales">
            <div class="panel-header">
                <span class="panel-title">Whale Watch</span>
                <span class="panel-count" id="whaleCount">-</span>
            </div>
            <div class="panel-content" id="whalePanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Main Character -->
        <section class="panel" data-panel="mainchar">
            <div class="panel-header">
                <span class="panel-title">Main Character</span>
                <span class="panel-count">Today</span>
            </div>
            <div class="panel-content" id="mainCharPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Money Printer -->
        <section class="panel" data-panel="printer">
            <div class="panel-header">
                <span class="panel-title">Money Printer</span>
                <span class="panel-count">Fed Balance Sheet</span>
            </div>
            <div class="panel-content" id="printerPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Government Contracts -->
        <section class="panel wide" data-panel="contracts">
            <div class="panel-header">
                <span class="panel-title">Gov Contracts</span>
                <span class="panel-count" id="contractsCount">-</span>
            </div>
            <div class="panel-content" id="contractsPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- AI Arms Race -->
        <section class="panel wide" data-panel="ai">
            <div class="panel-header">
                <span class="panel-title">AI Arms Race</span>
                <span class="panel-count" id="aiCount">-</span>
            </div>
            <div class="panel-content" id="aiPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Layoffs Tracker -->
        <section class="panel" data-panel="layoffs">
            <div class="panel-header">
                <span class="panel-title">Layoffs Tracker</span>
                <span class="panel-count" id="layoffsCount">-</span>
            </div>
            <div class="panel-content" id="layoffsPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Venezuela Situation -->
        <section class="panel" data-panel="venezuela">
            <div class="panel-header">
                <span class="panel-title">Venezuela Situation</span>
                <span class="panel-count" id="venezuelaStatus">-</span>
            </div>
            <div class="panel-content" id="venezuelaPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Greenland Situation -->
        <section class="panel" data-panel="greenland">
            <div class="panel-header">
                <span class="panel-title">Greenland Situation</span>
                <span class="panel-count" id="greenlandStatus">-</span>
            </div>
            <div class="panel-content" id="greenlandPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Intel Feed -->
        <section class="panel wide" data-panel="intel">
            <div class="panel-header">
                <span class="panel-title">Intel Feed</span>
                <span class="panel-count" id="intelCount">-</span>
            </div>
            <div class="panel-content" id="intelPanel">
                <div class="loading-msg">Loading...</div>
            </div>
        </section>

        <!-- Correlation Engine -->
        <section class="panel wide" data-panel="correlation">
            <div class="panel-header">
                <span class="panel-title">Correlation Engine</span>
                <span class="panel-count" id="correlationStatus">ANALYZING</span>
            </div>
            <div class="panel-content correlation-panel" id="correlationPanel">
                <div class="correlation-sections">
                    <div class="correlation-section">
                        <div class="correlation-section-header">
                            <span class="correlation-icon">üîÆ</span>
                            <span class="correlation-section-title">Emerging Patterns</span>
                        </div>
                        <div class="correlation-content" id="emergingPatterns">
                            <div class="loading-msg">Scanning for patterns...</div>
                        </div>
                    </div>
                    <div class="correlation-section">
                        <div class="correlation-section-header">
                            <span class="correlation-icon">üìà</span>
                            <span class="correlation-section-title">Momentum Signals</span>
                        </div>
                        <div class="correlation-content" id="momentumSignals">
                            <div class="loading-msg">Calculating momentum...</div>
                        </div>
                    </div>
                    <div class="correlation-section">
                        <div class="correlation-section-header">
                            <span class="correlation-icon">üîó</span>
                            <span class="correlation-section-title">Cross-Source Correlations</span>
                        </div>
                        <div class="correlation-content" id="crossSourceCorrelations">
                            <div class="loading-msg">Correlating sources...</div>
                        </div>
                    </div>
                    <div class="correlation-section">
                        <div class="correlation-section-header">
                            <span class="correlation-icon">‚ö°</span>
                            <span class="correlation-section-title">Predictive Signals</span>
                        </div>
                        <div class="correlation-content" id="predictiveSignals">
                            <div class="loading-msg">Generating predictions...</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Narrative Tracker -->
        <section class="panel wide" data-panel="narrative">
            <div class="panel-header">
                <span class="panel-title">Narrative Tracker</span>
                <span class="panel-count" id="narrativeStatus">TRACKING</span>
            </div>
            <div class="panel-content narrative-panel" id="narrativePanel">
                <div class="narrative-sections">
                    <div class="narrative-section">
                        <div class="narrative-section-header">
                            <span class="narrative-icon">üå±</span>
                            <span class="narrative-section-title">Emerging Fringe</span>
                        </div>
                        <div class="narrative-content" id="emergingFringe">
                            <div class="loading-msg">Scanning alternative sources...</div>
                        </div>
                    </div>
                    <div class="narrative-section">
                        <div class="narrative-section-header">
                            <span class="narrative-icon">üîÑ</span>
                            <span class="narrative-section-title">Fringe ‚Üí Mainstream</span>
                        </div>
                        <div class="narrative-content" id="fringeToMainstream">
                            <div class="loading-msg">Tracking crossover narratives...</div>
                        </div>
                    </div>
                    <div class="narrative-section">
                        <div class="narrative-section-header">
                            <span class="narrative-icon">üëÅ</span>
                            <span class="narrative-section-title">Narrative Watch</span>
                        </div>
                        <div class="narrative-content" id="narrativeWatch">
                            <div class="loading-msg">Monitoring active narratives...</div>
                        </div>
                    </div>
                    <div class="narrative-section">
                        <div class="narrative-section-header">
                            <span class="narrative-icon">üé≠</span>
                            <span class="narrative-section-title">Disinfo Signals</span>
                        </div>
                        <div class="narrative-content" id="disinfoSignals">
                            <div class="loading-msg">Analyzing signals...</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- My Monitors -->
        <section class="panel" data-panel="monitors">
            <div class="panel-header">
                <span class="panel-title">My Monitors</span>
                <span class="panel-count" id="monitorsCount">-</span>
            </div>
            <div class="panel-content" id="monitorsPanel">
                <div class="monitors-empty">
                    No monitors configured
                    <div class="monitors-empty-hint">Click Settings ‚Üí Add Monitor to get started</div>
                </div>
            </div>
        </section>

    </main>

    <!-- Load the modular JavaScript -->
    <script type="module" src="js/main.js"></script>
</body>
</html>
